# ML System Design Doc - [RU]
## Дизайн ML системы сервиса Margo

### 1. Цели и предпосылки
#### 1.1. Зачем идем в разработку продукта?

- Бизнес-цель:
  - Создать сервис с интерактивным аватаром, который поможет пользователям читать статьи, искать ключевую информацию из видео и расшифровывать сложные архитектуры
- Почему станет лучше, чем сейчас, от использования ML
  - Аватар упростит взаимодействие с информацией, снижая когнитивную нагрузку пользователя.
  - Использование ML улучшит качество понимания статей, контекстного выделения ключевых моментов из видео, предоставление более простой информации для лучшего понимания сложных архитектур, и оптимизация заметок по статье.
  - Персонализация позволит пользователям получать адаптированные ответы.
- Что будем считать успехом итерации с точки зрения бизнеса
  - Реализация MVP с цифровым аватаром, который может суммаризировать статьи и отвечать по ним на вопросы

#### 1.2. Бизнес-требования и ограничения

- Краткое описание БТ и ссылки на детальные документы с бизнес-требованиями
  - Интерактивный аватар должен быть простым в использовании, поддерживать мультимодальные запросы (текст, голос) и иметь визуальный интерфейс.
  - Сервис должен поддерживать 3 основные функции:
    - Чтение и реферирование текстов.
    - Извлечение информации из видео (ключевые моменты).
    - Извлечение информации из изображений
    - Объяснение через визуализацию(цифрового аватара).
- Бизнес-ограничения
  - Система должна уметь работать с русским языком
  - Система должна уметь работать в условиях ограниченных ресурсов(в идеале, без видеокарты, на конечном устройстве пользователя или по API)
  - Система должна иметь время отклика меньше 10 секунд
- Что мы ожидаем от конкретной итерации
  - MVP, которое работает на предобученных opensource моделях в открытом доступе(по API)
- Что считаем успешным пилотом? Критерии успеха и возможные пути развития проекта
  - Критерием успеха считаем появление MVP, тестирование на как минимум 100 пользователях и сборе положительной обратной связи(>=75%)

#### 1.3. Что входит в скоуп проекта/итерации, что не входит

- На закрытие каких БТ подписываемся в данной итерации
  - В данной итерации подписываемся на:
    - Визуального аватара
    - LLM агента с инструментами: поиск статей в интернете по свободному текстовому запросу, инструмент для суммаризации, RAG
    - Возможность загружать конкретные статьи для анализа
    -
- Что не будет закрыто: поиск информации по видео, VQA, подбор нейросетевых моделей для задачи и их валидация на тестовых данных, тестовых датасетов для валидации нейросетевых моделей
- Описание результата с точки зрения качества кода и воспроизводимости решения:
  - Репозиторий с модульной структурой (код + тесты).
  - Настроенные CI/CD процессы
  - Описания экспериментов по подбору открытых opensource моделей
- Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации)
  - Доработка аватара в режиме взаимодействия c пользователем realtime
  - Возможность для пользователя задать вопрос голосом

#### 1.4. Предпосылки решения
Для создания системы учитываем следюущие предпосылки:
- Используемые данные: используем только открытые интернет-источники в случае нативного поиска статей по запросу(arxiv, scholar, etc) или пользовательские данные в случае работы с данными пользователя
- Система должна уметь работать как минимум со сторонними открытыми API, дающими доступ к LLM
- Цифровой аватар должен быть приятным глазу
- Система должна уметь отвечать только по существу, на основе знаний по тем документам/статьям, которые в нее передали/нашли

### 2. Методология `Data Scientist`

#### 2.1. Постановка задачи

Разрабатываем систему, состоящую из 3 компонент:
- модуль для визуализации цифрового аватара
- TG бот
- модуль с LLM агентом
- модуль с fastapi, который будет оркестрировать модуль с LLM агентом и модуль с цифровым аватаром

Модуль с LLM агентом в свою очередь состоит из:
- supervisor
- RAG
- tool для поиска релевантных статей в интернете
- tool для суммаризации
- кэш для уже найденной информации

#### 2.2. Блок-схема решения

![arch.png](images/arch.png)


#### 2.3. Этапы решения задачи `Data Scientist`

- Для каждого этапа **по результатам EDA** описываем - **отдельно для бейзлайна** и **отдельно для основного MVP** - все про данные и технику решения максимально конкретно. Обозначаем необходимые вводные, технику предполагаемого решения и что ожидаем получить на выходе, чтобы перейти к следующему этапу.
- Как правило, детальное и структурированное заполнение раздела `2.3` возможно только **по результатам EDA**.
- Если описание в дизайн доке **шаблонно** - т.е. его можно скопировать и применить к разным продуктам, то оно **некорректно**. Дизайн док должен показывать схему решения для конкретной задачи, поставленной в части 1.

> Примеры этапов:
> - Этап 2 - Подготовка прогнозных моделей
> - Этап 3 - Интерпретация моделей (согл. с заказчиком)
> - Этап 4 - Интеграция бизнес правил для расчета бизнес-метрик качества модели
> - Этап 5 - Подготовка инференса модели по итерациям
> - Этап 6 - Интеграция бизнес правил
> - Этап 7 - Разработка оптимизатора (выбор оптимальной итерации)
> - Этап 8 - Подготовка финального отчета для бизнеса

*Этап 1 - это обычно, подготовка данных.*

В этом этапе должно быть следующее:

- Данные и сущности, на которых будет обучаться ваша модель машинного обучения. Отдельная таблица для целевой переменной (либо целевых переменных разных этапов), отдельная таблица – для признаков.

| Название данных  | Есть ли данные в компании (если да, название источника/витрин) | Требуемый ресурс для получения данных (какие роли нужны) | Проверено ли качество данных (да, нет) |
| ------------- | ------------- | ------------- | ------------- |
| Продажи | DATAMARTS_SALES_PER_DAY  | DE/DS | + |
| ...  | ...  | ... | ... |

- Краткое описание результата этапа - что должно быть на выходе: витрины данных, потоки данных, др.

> Чаще всего заполнение раздела невозможно без EDA.

 *Этапы 2 и далее, помимо подготовки данных.*

Описание техники **для каждого этапа** должно включать описание **отдельно для MVP** и **отдельно для бейзлайна**:

- Описание формирования выборки для обучения, тестирования и валидации. Выбор репрезентативных данных для экспериментов, обучения и подготовки пилота (от бизнес-цели и репрезентативности данных с технической точки зрения) `Data Scientist`
- Горизонт, гранулярность, частоту необходимого пересчета прогнозных моделей `Data Scientist`
- Определение целевой переменной, согласованное с бизнесом `Data Scientist`
- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`
- Необходимый результат этапа. Например, необходимым результатом может быть не просто достижение каких-либо метрик качества, а включение в модели определенных факторов (флаг промо для прогноза выручки, др.) `Data Scientist`
- Какие могут быть риски и что планируем с этим делать. Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`
- Верхнеуровневые принципы и обоснования для: feature engineering, подбора алгоритма решения, техники кросс-валидации, интерпретации результата (если применимо).
- Предусмотрена ли бизнес-проверка результата этапа и как будет проводиться `Data Scientist` & `Product Owner`

### 3. Подготовка пилота

#### 3.1. Способ оценки пилота

- Краткое описание предполагаемого дизайна и способа оценки пилота `Product Owner`, `Data Scientist` with `AB Group`

#### 3.2. Что считаем успешным пилотом

Формализованные в пилоте метрики оценки успешности `Product Owner`

#### 3.3. Подготовка пилота

- Что можем позволить себе, исходя из ожидаемых затрат на вычисления. Если исходно просчитать сложно, то описываем этап расчетов ожидаемой вычислительной сложности на эксперименте с бейзлайном. И предусматриваем уточнение параметров пилота и установку ограничений по вычислительной сложности моделей. `Data Scientist`

### 4. Внедрение `для production систем, если требуется`

> Заполнение раздела 4 требуется не для всех дизайн документов. В некоторых случаях результатом итерации может быть расчет каких-то значений, далее используемых в бизнес-процессе для пилота.

#### 4.1. Архитектура решения

- Блок схема и пояснения: сервисы, назначения, методы API `Data Scientist`

#### 4.2. Описание инфраструктуры и масштабируемости

- Какая инфраструктура выбрана и почему `Data Scientist`
- Плюсы и минусы выбора `Data Scientist`
- Почему финальный выбор лучше других альтернатив `Data Scientist`

#### 4.3. Требования к работе системы

- SLA, пропускная способность и задержка `Data Scientist`

#### 4.4. Безопасность системы

- Потенциальная уязвимость системы `Data Scientist`

#### 4.5. Безопасность данных

- Нет ли нарушений GDPR и других законов `Data Scientist`

#### 4.6. Издержки

- Расчетные издержки на работу системы в месяц `Data Scientist`

#### 4.5. Integration points

- Описание взаимодействия между сервисами (методы API и др.) `Data Scientist`

#### 4.6. Риски

- Описание рисков и неопределенностей, которые стоит предусмотреть `Data Scientist`

> ### Материалы для дополнительного погружения в тему
> - [Шаблон ML System Design Doc [EN] от AWS](https://github.com/eugeneyan/ml-design-docs) и [статья](https://eugeneyan.com/writing/ml-design-docs/) с объяснением каждого раздела
> - [Верхнеуровневый шаблон ML System Design Doc от Google](https://towardsdatascience.com/the-undeniable-importance-of-design-docs-to-data-scientists-421132561f3c) и [описание общих принципов его заполнения](https://towardsdatascience.com/understanding-design-docs-principles-for-achieving-data-scientists-53e6d5ad6f7e).
> - [ML Design Template](https://www.mle-interviews.com/ml-design-template) от ML Engineering Interviews
> - Статья [Design Documents for ML Models](https://medium.com/people-ai-engineering/design-documents-for-ml-models-bbcd30402ff7) на Medium. Верхнеуровневые рекомендации по содержанию дизайн-документа и объяснение, зачем он вообще нужен
> - [Краткий Canvas для ML-проекта от Made with ML](https://madewithml.com/courses/mlops/design/#timeline). Подходит для верхнеуровневого описания идеи, чтобы понять, имеет ли смысл идти дальше.
